# BBR拥塞控制算法原理

> 至于为什么会想提到BBR这个东西，如果不用`projectV`那:airplane:加速经常会用到。:dog:
>
> 不得不说，这一块，确实对不起《计算机网络》的老师。:sweat_smile:

几个概念：

- `RTT`

  报文的往返时延。

- `BDP`

  带宽时延积，例如一条链路的带宽是100Mbps，而RTT是40ms，那么

  ```markdown
  BDP=100Mbps*0.04s=4Mb=0.5MB
  ```

  即平均每秒飞行中的报文应当是0.5MB。

- `CUBIC`

  `Linux`使用的一种拥塞算法。

- `BBR`

  Google设计的新的拥塞算法，`Linux`之后也进行了采用。

## 为什么会发生拥塞

TCP协议是面向字符流的协议，它允许应用层基于read/write方法来发送、读取任意长的字符流。

但TCP之下的`IP层`是基于块状的`Packet`报文来分片发送的，因此，TCP协议需要将应用交付给它的字符流拆分成多个`Packet`（在TCP传输层被称为`Segment`）发送，由于网速有变化且接收主机的处理性能有限，TCP还要决定何时发送这些Segment。

TCP**滑动窗口**（数据的可靠性，传输效率，动态调整）解决了Client、Server主机之间的问题，但没有去管连接中大量路由器、交换机转发IP报文的问题，因此当瓶颈路由器的输入流大于其输出流时，便会发生拥塞。

## 拥塞控制

如果由于瓶颈路由器等造成网速下降，但发送方不管不顾的话，路由器的缓冲队列填满后便会发生大量丢包，且此时RTT（报文往返时间）由于存在长队列而极高。TCP的拥塞控制便用于解决这个问题。

在BBR出现前，拥塞控制分为四个部分：慢启动、拥塞避免、快速重传、快速恢复。

​		`慢启动`是在不知道连接的瓶颈带宽时，以起始较低的发送速率，以每RTT两倍的速度快速增加发送速率，直到到达一个阈值。

​		到该阈值后，进入线性提高发送速率的阶段，该阶段叫做`拥塞避免`。

​		直到发生丢包后，发送速率大幅下降，针对丢包使用`快速重传算法`重送发送，同时也使用快速恢复算法把发送速率尽量平滑的升上来。



`CUBIC`是基于丢包的拥塞控制算法，其对`RTT`的敏感性更高，但是在进行对`BDP`的检测和收敛时太晚，这又会造成更大的RTT时延，导致更多的丢包。

`BRR`是通过检测`RTprop`（链路的物理时延）和`BtlBw`（瓶颈带宽）来实现拥塞控制，这是通过相关计算和拟合出这两个关键参数，使得可以尽早对传输速率进行调整，避免在路由的缓存队列中堆积过量的包造成延时，再造成更多的丢包。



## 参考

[一文解释清楚Google BBR拥塞控制算法原理](https://cloud.tencent.com/developer/article/1482633)